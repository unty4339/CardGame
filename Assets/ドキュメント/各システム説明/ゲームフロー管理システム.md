# クラス説明

- GameFlowManager
    - Monobehaviorを継承する
    - シングルトンパターンを採用
    - ゲーム全体のフロー管理について責任を持つ
    - InitializeBattle (): 戦闘を初期化する
    - StartTurn (int playerId): ターンプレイヤーIDを受け取り、ターン開始処理を行う
    - EndTurn (int playerId): ターンプレイヤーIDを受け取り、ターン終了処理を行う
    - CheckGameEnd (): 終了条件を判定し、勝敗があれば返す

- DeckBuilder
    - デッキ手札システムで定義済み

- PlayerManager
    - プレイヤー情報システムで定義済み

- AIController
    - ステート管理AIシステムで定義済み

- ActionQueueManager
    - 操作アニメーションシステムで定義済み

- DialogueManager
    - 台詞マネージャシステムで定義済み

# 処理シーケンス

## 戦闘初期化の処理シーケンス

1. 初期化開始（GameFlowManager）
    - InitializeBattle()が呼ばれる

2. 先攻・後攻の決定（GameFlowManager）
    - 先攻プレイヤーと後攻プレイヤーをランダムまたは固定ルールで決定する

3. デッキの構築（GameFlowManager → DeckBuilder）
    - 各プレイヤーのDeckRecipeを元にDeckBuilder.BuildDeck()でデッキを作成する
    - デッキをシャッフルする

4. 初期ドロー（GameFlowManager → PlayerManager）
    - 各プレイヤーにカードを5枚ずつ引かせる
    - PlayerManager.DrawCard()を5回呼ぶ

5. マリガン（GameFlowManager）
    - 各プレイヤーに一度だけマリガンの機会を与える
    - 戻すカードを選択してデッキに戻し、シャッフルし、戻した数だけ引き直す

6. 初期値の設定（GameFlowManager → PlayerManager）
    - 各プレイヤーのHPを15に設定する
    - 各プレイヤーの最大MPを0、現在MPを0に設定する

## ターン開始の処理シーケンス

1. ターン開始（GameFlowManager）
    - StartTurn(turnPlayerId)が呼ばれる

2. ドロー（GameFlowManager → PlayerManager）
    - ターンプレイヤーにデッキからカードを1枚引かせる
    - カードを引けないプレイヤーは敗北とする

3. MP回復と攻撃権付与（GameFlowManager → PlayerManager）
    - ターンプレイヤーの最大MPを+1する
    - ターンプレイヤーの現在MPを最大MPで全回復する
    - ターンプレイヤーのフィールドゾーンの全ユニットに攻撃権を付与する

4. メインフェーズの分岐（GameFlowManager）
    - AIプレイヤーの場合、手順5aへ
    - ユーザープレイヤーの場合、手順5bへ

5a. AIプレイヤーのターン処理
    - AIController.CreateState()で現在の状態を作成する
    - AIController.DecideActions()で行動キューを作成する
    - ActionQueueManagerに行動を追加し、キューに沿ってオブジェクトを操作する
    - キューがなくなった時点でターン終了処理へ

5b. ユーザープレイヤーのターン処理
    - 画面を操作し、有効な行動操作をするたびにActionQueueManager.AddAction()で行動をキューに追加する
    - 並行してActionQueueManagerがキューを消化し、アニメーションを流しつつオブジェクトを操作する
    - ターン終了ボタンを押した時点でターン終了行動をキューに追加する

## 終了条件判定の処理シーケンス

1. 判定タイミング（GameFlowManager）
    - ドロー時、攻撃後、その他ゲーム状態が変化したタイミングでCheckGameEnd()が呼ばれる

2. HP判定（GameFlowManager）
    - 一方のプレイヤーのHPが0以下になった場合、もう一方の勝利とする

3. ドロー敗北判定（GameFlowManager）
    - カードを引けない（デッキが空の状態でドローしようとした）プレイヤーは敗北とする

4. ゲーム継続（GameFlowManager）
    - 終了条件を満たしていない場合、nullまたは継続フラグを返し、次のターンへ進む
