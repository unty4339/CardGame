# クラス説明

- Unit
    - ユニットトーテムシステムで定義済み

- KeywordAbility
    - ユニットトーテムシステムで定義済み

- BattleManager
    - Monobehaviorを継承する
    - シングルトンパターンを採用
    - 戦闘の実行と攻撃ルールの適用について責任を持つ
    - CanAttackUnit (Unit attacker, Unit target, FieldZone opponentField): 攻撃側ユニット、対象ユニット、相手フィールドを受け取り、ユニットへの攻撃が可能か判定する
    - CanAttackPlayer (Unit attacker, FieldZone opponentField): 攻撃側ユニット、相手フィールドを受け取り、プレイヤーへの攻撃が可能か判定する
    - ExecuteAttack (Unit attacker, object target): 攻撃側ユニットと攻撃対象を受け取り、攻撃を実行する

- AttackResolver
    - Monobehaviorを継承しない
    - 攻撃時のダメージ計算と結果の適用について責任を持つ
    - ResolveUnitAttack (Unit attacker, Unit defender): 攻撃側ユニットと防御側ユニットを受け取り、双方の体力を減らし破壊判定を行う
    - ResolvePlayerAttack (Unit attacker, int targetPlayerId): 攻撃側ユニットと対象プレイヤーIDを受け取り、相手HPを減らす
    - パートナーが破壊された場合はパートナーゾーンに戻す処理を行う

# 処理シーケンス

## 攻撃可否判定の処理シーケンス

1. 攻撃対象選択時（戦闘システム利用側 → BattleManager）
    - 攻撃側Unitと攻撃対象（UnitまたはPlayer）が渡される
    - ユニットへの攻撃の場合はCanAttackUnit()が呼ばれる
    - プレイヤーへの攻撃の場合はCanAttackPlayer()が呼ばれる

2. 攻撃権の確認（BattleManager）
    - 攻撃側UnitのCanAttackがtrueであることを確認する
    - falseの場合、攻撃不可として返す

3. 速攻・神速の確認（BattleManager）
    - 攻撃対象がユニットの場合、TurnsOnFieldが0かつKeywordsに速攻も神速も含まない場合は攻撃不可
    - 攻撃対象がプレイヤーの場合、TurnsOnFieldが0かつKeywordsに神速が含まれない場合は攻撃不可

4. 守護の確認（BattleManager）
    - 攻撃対象がプレイヤーの場合、相手フィールドに守護を持つユニットがいるか確認する
    - いる場合、プレイヤーへの攻撃は不可とする

5. 結果の返却（BattleManager）
    - 以上の条件を全て満たす場合、攻撃可能として返す

## 攻撃実行の処理シーケンス

1. 攻撃実行リクエスト（操作アニメーションシステム → BattleManager）
    - 攻撃側Unitと攻撃対象が渡される
    - ExecuteAttack()が呼ばれる

2. ユニット攻撃の場合（BattleManager → AttackResolver）
    - 攻撃対象がUnitの場合、AttackResolver.ResolveUnitAttack()を呼ぶ
    - 攻撃側の攻撃力分、防御側の体力を減少させる
    - 防御側の攻撃力分、攻撃側の体力を減少させる
    - 双方の体力が0以下になったユニットを破壊扱いとする
    - パートナーであるユニットが破壊された場合、パートナーゾーンに戻す

3. プレイヤー攻撃の場合（BattleManager → AttackResolver）
    - 攻撃対象がプレイヤーの場合、AttackResolver.ResolvePlayerAttack()を呼ぶ
    - 攻撃側の攻撃力分、対象プレイヤーのHPを減少させる
    - HPが0以下になった場合、勝利判定へ遷移する

4. 攻撃権の消費（BattleManager）
    - 攻撃側UnitのCanAttackをfalseに設定する
    - 次のターン開始時に再度trueになる
